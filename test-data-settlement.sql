-- ============================================
-- Settlement API 테스트용 데이터 생성 스크립트
-- ============================================

-- 1. 기존 테스트 데이터 확인
SELECT '=== 기존 데이터 확인 ===' AS 'Step';

SELECT 'USERS 테이블 확인' AS 'Table';
SELECT * FROM USERS WHERE USER_ID IN ('user_member1', 'user_member2', 'user_leader1');

SELECT 'ACCOUNT 테이블 확인' AS 'Table';
SELECT * FROM ACCOUNT WHERE USER_ID = 'user_leader1';

SELECT 'PARTY 테이블 확인' AS 'Table';
SELECT * FROM PARTY WHERE PARTY_LEADER_ID = 'user_leader1';

SELECT 'PAYMENT 테이블 확인' AS 'Table';
SELECT * FROM PAYMENT WHERE PARTY_ID IN (SELECT PARTY_ID FROM PARTY WHERE PARTY_LEADER_ID = 'user_leader1');

SELECT 'SETTLEMENT 테이블 확인' AS 'Table';
SELECT * FROM SETTLEMENT;

-- ============================================
-- 테스트 데이터가 없는 경우 아래 스크립트 실행
-- ============================================

-- 2. 테스트용 사용자 생성 (이미 있으면 스킵)
INSERT IGNORE INTO USERS (USER_ID, PASSWORD, NICKNAME, PHONE, ROLE, USER_STATUS, REG_DATE, CI, DI, AGREE_MARKETING)
VALUES 
('user_leader1', 'password123', '방장1', '010-1111-1111', 'USER', 'ACTIVE', CURDATE(), 'CI_LEADER1', 'DI_LEADER1', 1),
('user_member1', 'password123', '멤버1', '010-2222-2222', 'USER', 'ACTIVE', CURDATE(), 'CI_MEMBER1', 'DI_MEMBER1', 1),
('user_member2', 'password123', '멤버2', '010-3333-3333', 'USER', 'ACTIVE', CURDATE(), 'CI_MEMBER2', 'DI_MEMBER2', 1),
('user_member3', 'password123', '멤버3', '010-4444-4444', 'USER', 'ACTIVE', CURDATE(), 'CI_MEMBER3', 'DI_MEMBER3', 1);

-- 3. 테스트용 계좌 생성 (방장 계좌)
INSERT IGNORE INTO ACCOUNT (ACCOUNT_ID, USER_ID, BANK_CODE, BANK_NAME, ACCOUNT_NUMBER, ACCOUNT_HOLDER, IS_VERIFIED, REG_DATE, VERIFY_DATE)
VALUES 
(1, 'user_leader1', '004', '국민은행', '123456789012', '방장1', 'Y', NOW(), NOW());

-- 4. 테스트용 카테고리 생성
INSERT IGNORE INTO CATEGORY (CATEGORY_ID, CATEGORY_NAME)
VALUES (1, 'OTT');

-- 5. 테스트용 상품 생성
INSERT IGNORE INTO PRODUCT (PRODUCT_ID, CATEGORY_ID, PRODUCT_NAME, PRODUCT_STATUS, PRICE, IMAGE)
VALUES 
(1, 1, 'Netflix', 'ACTIVE', 13000, NULL),
(2, 1, 'Disney+', 'ACTIVE', 9900, NULL);

-- 6. 테스트용 파티 생성
INSERT IGNORE INTO PARTY (PARTY_ID, PRODUCT_ID, PARTY_LEADER_ID, PARTY_STATUS, MAX_MEMBERS, CURRENT_MEMBERS, MONTHLY_FEE, OTT_ID, OTT_PASSWORD, ACCOUNT_ID, REG_DATE, START_DATE)
VALUES 
(1, 1, 'user_leader1', 'ACTIVE', 4, 4, 13000, 'netflix@test.com', 'password123', 1, DATE_SUB(NOW(), INTERVAL 2 MONTH), DATE_SUB(NOW(), INTERVAL 2 MONTH)),
(2, 2, 'user_leader1', 'ACTIVE', 4, 3, 9900, 'disney@test.com', 'password123', 1, DATE_SUB(NOW(), INTERVAL 1 MONTH), DATE_SUB(NOW(), INTERVAL 1 MONTH));

-- 7. 테스트용 파티 멤버 생성
INSERT IGNORE INTO PARTY_MEMBER (PARTY_MEMBER_ID, PARTY_ID, USER_ID, MEMBER_ROLE, MEMBER_STATUS, JOIN_DATE)
VALUES 
-- 파티 1 멤버 (4명 - 방장 포함)
(1, 1, 'user_leader1', 'LEADER', 'ACTIVE', DATE_SUB(NOW(), INTERVAL 2 MONTH)),
(2, 1, 'user_member1', 'MEMBER', 'ACTIVE', DATE_SUB(NOW(), INTERVAL 2 MONTH)),
(3, 1, 'user_member2', 'MEMBER', 'ACTIVE', DATE_SUB(NOW(), INTERVAL 2 MONTH)),
(4, 1, 'user_member3', 'MEMBER', 'ACTIVE', DATE_SUB(NOW(), INTERVAL 2 MONTH)),

-- 파티 2 멤버 (3명 - 방장 포함)
(5, 2, 'user_leader1', 'LEADER', 'ACTIVE', DATE_SUB(NOW(), INTERVAL 1 MONTH)),
(6, 2, 'user_member1', 'MEMBER', 'ACTIVE', DATE_SUB(NOW(), INTERVAL 1 MONTH)),
(7, 2, 'user_member2', 'MEMBER', 'ACTIVE', DATE_SUB(NOW(), INTERVAL 1 MONTH));

-- 8. 테스트용 결제 데이터 생성 (정산 대상)
-- 파티 1: 2개월 전 결제 (2025-10월)
INSERT IGNORE INTO PAYMENT (PAYMENT_ID, PARTY_ID, PARTY_MEMBER_ID, USER_ID, PAYMENT_TYPE, PAYMENT_AMOUNT, PAYMENT_STATUS, PAYMENT_METHOD, PAYMENT_DATE, TARGET_MONTH)
VALUES 
(101, 1, 2, 'user_member1', 'MONTHLY', 3250, 'COMPLETED', 'CARD', DATE_SUB(NOW(), INTERVAL 2 MONTH), DATE_FORMAT(DATE_SUB(NOW(), INTERVAL 2 MONTH), '%Y-%m')),
(102, 1, 3, 'user_member2', 'MONTHLY', 3250, 'COMPLETED', 'CARD', DATE_SUB(NOW(), INTERVAL 2 MONTH), DATE_FORMAT(DATE_SUB(NOW(), INTERVAL 2 MONTH), '%Y-%m')),
(103, 1, 4, 'user_member3', 'MONTHLY', 3250, 'COMPLETED', 'CARD', DATE_SUB(NOW(), INTERVAL 2 MONTH), DATE_FORMAT(DATE_SUB(NOW(), INTERVAL 2 MONTH), '%Y-%m'));

-- 파티 1: 1개월 전 결제 (2025-11월)
INSERT IGNORE INTO PAYMENT (PAYMENT_ID, PARTY_ID, PARTY_MEMBER_ID, USER_ID, PAYMENT_TYPE, PAYMENT_AMOUNT, PAYMENT_STATUS, PAYMENT_METHOD, PAYMENT_DATE, TARGET_MONTH)
VALUES 
(104, 1, 2, 'user_member1', 'MONTHLY', 3250, 'COMPLETED', 'CARD', DATE_SUB(NOW(), INTERVAL 1 MONTH), DATE_FORMAT(DATE_SUB(NOW(), INTERVAL 1 MONTH), '%Y-%m')),
(105, 1, 3, 'user_member2', 'MONTHLY', 3250, 'COMPLETED', 'CARD', DATE_SUB(NOW(), INTERVAL 1 MONTH), DATE_FORMAT(DATE_SUB(NOW(), INTERVAL 1 MONTH), '%Y-%m')),
(106, 1, 4, 'user_member3', 'MONTHLY', 3250, 'COMPLETED', 'CARD', DATE_SUB(NOW(), INTERVAL 1 MONTH), DATE_FORMAT(DATE_SUB(NOW(), INTERVAL 1 MONTH), '%Y-%m'));

-- 파티 2: 1개월 전 결제 (2025-11월)
INSERT IGNORE INTO PAYMENT (PAYMENT_ID, PARTY_ID, PARTY_MEMBER_ID, USER_ID, PAYMENT_TYPE, PAYMENT_AMOUNT, PAYMENT_STATUS, PAYMENT_METHOD, PAYMENT_DATE, TARGET_MONTH)
VALUES 
(107, 2, 6, 'user_member1', 'MONTHLY', 2475, 'COMPLETED', 'CARD', DATE_SUB(NOW(), INTERVAL 1 MONTH), DATE_FORMAT(DATE_SUB(NOW(), INTERVAL 1 MONTH), '%Y-%m')),
(108, 2, 7, 'user_member2', 'MONTHLY', 2475, 'COMPLETED', 'CARD', DATE_SUB(NOW(), INTERVAL 1 MONTH), DATE_FORMAT(DATE_SUB(NOW(), INTERVAL 1 MONTH), '%Y-%m'));

-- 9. 테스트용 정산 데이터 생성
-- 정산 1: 파티 1, 2025-10월 정산 (완료)
INSERT IGNORE INTO SETTLEMENT (SETTLEMENT_ID, PARTY_ID, PARTY_LEADER_ID, ACCOUNT_ID, SETTLEMENT_MONTH, SETTLEMENT_TYPE, TOTAL_AMOUNT, COMMISSION_RATE, COMMISSION_AMOUNT, NET_AMOUNT, SETTLEMENT_STATUS, SETTLEMENT_DATE, REG_DATE)
VALUES 
(1, 1, 'user_leader1', 1, DATE_FORMAT(DATE_SUB(NOW(), INTERVAL 2 MONTH), '%Y-%m'), 'MONTHLY', 9750, 0.15, 1462, 8288, 'COMPLETED', DATE_SUB(NOW(), INTERVAL 1 MONTH), DATE_SUB(NOW(), INTERVAL 1 MONTH));

-- 정산 2: 파티 1, 2025-11월 정산 (대기)
INSERT IGNORE INTO SETTLEMENT (SETTLEMENT_ID, PARTY_ID, PARTY_LEADER_ID, ACCOUNT_ID, SETTLEMENT_MONTH, SETTLEMENT_TYPE, TOTAL_AMOUNT, COMMISSION_RATE, COMMISSION_AMOUNT, NET_AMOUNT, SETTLEMENT_STATUS, REG_DATE)
VALUES 
(2, 1, 'user_leader1', 1, DATE_FORMAT(DATE_SUB(NOW(), INTERVAL 1 MONTH), '%Y-%m'), 'MONTHLY', 9750, 0.15, 1462, 8288, 'PENDING', NOW());

-- 정산 3: 파티 2, 2025-11월 정산 (대기)
INSERT IGNORE INTO SETTLEMENT (SETTLEMENT_ID, PARTY_ID, PARTY_LEADER_ID, ACCOUNT_ID, SETTLEMENT_MONTH, SETTLEMENT_TYPE, TOTAL_AMOUNT, COMMISSION_RATE, COMMISSION_AMOUNT, NET_AMOUNT, SETTLEMENT_STATUS, REG_DATE)
VALUES 
(3, 2, 'user_leader1', 1, DATE_FORMAT(DATE_SUB(NOW(), INTERVAL 1 MONTH), '%Y-%m'), 'MONTHLY', 4950, 0.15, 742, 4208, 'PENDING', NOW());

-- 10. 테스트용 정산 상세 데이터 생성
-- 정산 1 상세 (파티 1, 2025-10월)
INSERT IGNORE INTO SETTLEMENT_DETAIL (DETAIL_ID, SETTLEMENT_ID, PAYMENT_ID, PARTY_MEMBER_ID, USER_ID, PAYMENT_AMOUNT, REG_DATE)
VALUES 
(1, 1, 101, 2, 'user_member1', 3250, DATE_SUB(NOW(), INTERVAL 1 MONTH)),
(2, 1, 102, 3, 'user_member2', 3250, DATE_SUB(NOW(), INTERVAL 1 MONTH)),
(3, 1, 103, 4, 'user_member3', 3250, DATE_SUB(NOW(), INTERVAL 1 MONTH));

-- 정산 2 상세 (파티 1, 2025-11월)
INSERT IGNORE INTO SETTLEMENT_DETAIL (DETAIL_ID, SETTLEMENT_ID, PAYMENT_ID, PARTY_MEMBER_ID, USER_ID, PAYMENT_AMOUNT, REG_DATE)
VALUES 
(4, 2, 104, 2, 'user_member1', 3250, NOW()),
(5, 2, 105, 3, 'user_member2', 3250, NOW()),
(6, 2, 106, 4, 'user_member3', 3250, NOW());

-- 정산 3 상세 (파티 2, 2025-11월)
INSERT IGNORE INTO SETTLEMENT_DETAIL (DETAIL_ID, SETTLEMENT_ID, PAYMENT_ID, PARTY_MEMBER_ID, USER_ID, PAYMENT_AMOUNT, REG_DATE)
VALUES 
(7, 3, 107, 6, 'user_member1', 2475, NOW()),
(8, 3, 108, 7, 'user_member2', 2475, NOW());

-- 11. 결과 확인
SELECT '=== 생성된 테스트 데이터 확인 ===' AS 'Result';

SELECT 'SETTLEMENT 테이블' AS 'Table', COUNT(*) AS 'Count' FROM SETTLEMENT;
SELECT * FROM SETTLEMENT ORDER BY SETTLEMENT_ID;

SELECT 'SETTLEMENT_DETAIL 테이블' AS 'Table', COUNT(*) AS 'Count' FROM SETTLEMENT_DETAIL;
SELECT * FROM SETTLEMENT_DETAIL ORDER BY DETAIL_ID;

SELECT 'PAYMENT 테이블 (정산 대상)' AS 'Table', COUNT(*) AS 'Count' FROM PAYMENT WHERE PAYMENT_ID >= 101;
SELECT * FROM PAYMENT WHERE PAYMENT_ID >= 101 ORDER BY PAYMENT_ID;

-- 12. 정산 요약 정보
SELECT '=== 정산 요약 ===' AS 'Summary';

SELECT 
    s.SETTLEMENT_ID,
    s.PARTY_ID,
    s.SETTLEMENT_MONTH,
    s.TOTAL_AMOUNT AS '총액',
    s.COMMISSION_AMOUNT AS '수수료',
    s.NET_AMOUNT AS '순정산액',
    s.SETTLEMENT_STATUS AS '상태',
    COUNT(sd.DETAIL_ID) AS '결제건수'
FROM SETTLEMENT s
LEFT JOIN SETTLEMENT_DETAIL sd ON s.SETTLEMENT_ID = sd.SETTLEMENT_ID
GROUP BY s.SETTLEMENT_ID
ORDER BY s.SETTLEMENT_ID;
