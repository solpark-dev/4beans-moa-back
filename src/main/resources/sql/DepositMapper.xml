<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.moa.dao.deposit.DepositDao">

    <!-- ====================================== -->
    <!-- ResultMap 정의 -->
    <!-- ====================================== -->

    <!-- Deposit 기본 ResultMap -->
    <resultMap id="DepositResultMap" type="com.moa.domain.Deposit">
        <id property="depositId" column="DEPOSIT_ID"/>
        <result property="partyId" column="PARTY_ID"/>
        <result property="partyMemberId" column="PARTY_MEMBER_ID"/>
        <result property="userId" column="USER_ID"/>
        <result property="depositType" column="DEPOSIT_TYPE"/>
        <result property="depositAmount" column="DEPOSIT_AMOUNT"/>
        <result property="depositStatus" column="DEPOSIT_STATUS"/>
        <result property="paymentDate" column="PAYMENT_DATE"/>
        <result property="refundDate" column="REFUND_DATE"/>
        <result property="refundAmount" column="REFUND_AMOUNT"/>
        <result property="transactionDate" column="TRANSACTION_DATE"/>
        <result property="tossPaymentKey" column="TOSS_PAYMENT_KEY"/>
        <result property="orderId" column="ORDER_ID"/>
    </resultMap>

    <!-- DepositResponse ResultMap (JOIN 포함) -->
    <resultMap id="DepositResponseResultMap" type="com.moa.dto.deposit.response.DepositResponse">
        <id property="depositId" column="DEPOSIT_ID"/>
        <result property="partyId" column="PARTY_ID"/>
        <result property="partyMemberId" column="PARTY_MEMBER_ID"/>
        <result property="userId" column="USER_ID"/>
        <result property="depositType" column="DEPOSIT_TYPE"/>
        <result property="depositAmount" column="DEPOSIT_AMOUNT"/>
        <result property="depositStatus" column="DEPOSIT_STATUS"/>
        <result property="paymentDate" column="PAYMENT_DATE"/>
        <result property="refundDate" column="REFUND_DATE"/>
        <result property="refundAmount" column="REFUND_AMOUNT"/>
        <result property="tossPaymentKey" column="TOSS_PAYMENT_KEY"/>
        <result property="orderId" column="ORDER_ID"/>

        <!-- JOIN 데이터 -->
        <result property="partyLeaderNickname" column="PARTY_LEADER_NICKNAME"/>
        <result property="productName" column="PRODUCT_NAME"/>
        <result property="userNickname" column="USER_NICKNAME"/>
    </resultMap>

    <!-- ====================================== -->
    <!-- INSERT -->
    <!-- ====================================== -->

    <!-- 보증금 생성 -->
    <insert id="insertDeposit" parameterType="com.moa.domain.Deposit"
            useGeneratedKeys="true" keyProperty="depositId" keyColumn="DEPOSIT_ID">
        INSERT INTO DEPOSIT (
            PARTY_ID,
            PARTY_MEMBER_ID,
            USER_ID,
            DEPOSIT_TYPE,
            DEPOSIT_AMOUNT,
            DEPOSIT_STATUS,
            PAYMENT_DATE,
            TRANSACTION_DATE,
            TOSS_PAYMENT_KEY,
            ORDER_ID
        ) VALUES (
                     #{partyId},
                     #{partyMemberId},
                     #{userId},
                     #{depositType},
                     #{depositAmount},
                     #{depositStatus},
                     #{paymentDate},
                     NOW(),
                     #{tossPaymentKey},
                     #{orderId}
                 )
    </insert>

    <!-- ====================================== -->
    <!-- SELECT -->
    <!-- ====================================== -->

    <!-- 보증금 ID로 조회 -->
    <select id="findById" parameterType="int" resultMap="DepositResultMap">
        SELECT *
        FROM DEPOSIT
        WHERE DEPOSIT_ID = #{depositId}
    </select>

    <!-- 보증금 상세 조회 (JOIN) -->
    <select id="findDetailById" parameterType="int" resultMap="DepositResponseResultMap">
        SELECT
            D.DEPOSIT_ID,
            D.PARTY_ID,
            D.PARTY_MEMBER_ID,
            D.USER_ID,
            D.DEPOSIT_TYPE,
            D.DEPOSIT_AMOUNT,
            D.DEPOSIT_STATUS,
            D.PAYMENT_DATE,
            D.REFUND_DATE,
            D.REFUND_AMOUNT,
            D.TOSS_PAYMENT_KEY,
            D.ORDER_ID,

            -- 파티 정보
            LEADER.NICKNAME AS PARTY_LEADER_NICKNAME,

            -- 상품 정보
            PROD.PRODUCT_NAME,

            -- 사용자 정보
            U.NICKNAME AS USER_NICKNAME
        FROM DEPOSIT D
                 INNER JOIN PARTY P ON D.PARTY_ID = P.PARTY_ID
                 INNER JOIN USERS LEADER ON P.PARTY_LEADER_ID = LEADER.USER_ID
                 INNER JOIN PRODUCT PROD ON P.PRODUCT_ID = PROD.PRODUCT_ID
                 INNER JOIN USERS U ON D.USER_ID = U.USER_ID
        WHERE D.DEPOSIT_ID = #{depositId}
    </select>

    <!-- 파티 멤버 ID로 보증금 조회 -->
    <select id="findByPartyMemberId" parameterType="int" resultMap="DepositResultMap">
        SELECT *
        FROM DEPOSIT
        WHERE PARTY_MEMBER_ID = #{partyMemberId}
    </select>

    <!-- 사용자 ID로 보증금 목록 조회 -->
    <select id="findByUserId" parameterType="string" resultMap="DepositResponseResultMap">
        SELECT
            D.DEPOSIT_ID,
            D.PARTY_ID,
            D.PARTY_MEMBER_ID,
            D.USER_ID,
            D.DEPOSIT_TYPE,
            D.DEPOSIT_AMOUNT,
            D.DEPOSIT_STATUS,
            D.PAYMENT_DATE,
            D.REFUND_DATE,
            D.REFUND_AMOUNT,
            D.TOSS_PAYMENT_KEY,
            D.ORDER_ID,

            LEADER.NICKNAME AS PARTY_LEADER_NICKNAME,
            PROD.PRODUCT_NAME,
            U.NICKNAME AS USER_NICKNAME
        FROM DEPOSIT D
                 INNER JOIN PARTY P ON D.PARTY_ID = P.PARTY_ID
                 INNER JOIN USERS LEADER ON P.PARTY_LEADER_ID = LEADER.USER_ID
                 INNER JOIN PRODUCT PROD ON P.PRODUCT_ID = PROD.PRODUCT_ID
                 INNER JOIN USERS U ON D.USER_ID = U.USER_ID
        WHERE D.USER_ID = #{userId}
        ORDER BY D.PAYMENT_DATE DESC
    </select>

    <!-- 파티 ID로 보증금 목록 조회 -->
    <select id="findByPartyId" parameterType="int" resultMap="DepositResponseResultMap">
        SELECT
            D.DEPOSIT_ID,
            D.PARTY_ID,
            D.PARTY_MEMBER_ID,
            D.USER_ID,
            D.DEPOSIT_TYPE,
            D.DEPOSIT_AMOUNT,
            D.DEPOSIT_STATUS,
            D.PAYMENT_DATE,
            D.REFUND_DATE,
            D.REFUND_AMOUNT,
            D.TOSS_PAYMENT_KEY,
            D.ORDER_ID,

            LEADER.NICKNAME AS PARTY_LEADER_NICKNAME,
            PROD.PRODUCT_NAME,
            U.NICKNAME AS USER_NICKNAME
        FROM DEPOSIT D
                 INNER JOIN PARTY P ON D.PARTY_ID = P.PARTY_ID
                 INNER JOIN USERS LEADER ON P.PARTY_LEADER_ID = LEADER.USER_ID
                 INNER JOIN PRODUCT PROD ON P.PRODUCT_ID = PROD.PRODUCT_ID
                 INNER JOIN USERS U ON D.USER_ID = U.USER_ID
        WHERE D.PARTY_ID = #{partyId}
        ORDER BY D.PAYMENT_DATE DESC
    </select>

    <!-- 파티 ID + 사용자 ID로 보증금 조회 (PAID 상태) -->
    <select id="findByPartyIdAndUserId" resultMap="DepositResultMap">
        SELECT *
        FROM DEPOSIT
        WHERE PARTY_ID = #{partyId}
          AND USER_ID = #{userId}
          AND DEPOSIT_STATUS = 'PAID'
        ORDER BY PAYMENT_DATE DESC
        LIMIT 1
    </select>

    <!-- 보증금 업데이트 (환불 등) -->
    <update id="updateDeposit" parameterType="com.moa.domain.Deposit">
        UPDATE DEPOSIT
        SET
            DEPOSIT_STATUS = #{depositStatus},
            REFUND_DATE = #{refundDate},
            REFUND_AMOUNT = #{refundAmount}
        WHERE DEPOSIT_ID = #{depositId}
    </update>

    <!-- 정산 기간 내 몰수된 보증금 조회 -->
    <select id="findForfeitedByPartyIdAndPeriod" resultMap="DepositResultMap">
        SELECT *
        FROM DEPOSIT
        WHERE PARTY_ID = #{partyId}
          AND DEPOSIT_STATUS = 'FORFEITED'
          AND REFUND_DATE BETWEEN #{startDate} AND #{endDate}
        ORDER BY REFUND_DATE ASC
    </select>

    <!-- ====================================== -->
    <!-- DELETE -->
    <!-- ====================================== -->

    <!-- 보증금 삭제 (PENDING 상태 정리용) -->
    <delete id="deleteById" parameterType="int">
        DELETE FROM DEPOSIT
        WHERE DEPOSIT_ID = #{depositId}
    </delete>

    <!-- 오래된 PENDING 상태 보증금 삭제 -->
    <delete id="deleteStalePendingRecords">
        DELETE FROM DEPOSIT
        WHERE DEPOSIT_STATUS = 'PENDING'
          AND TRANSACTION_DATE &lt; #{cutoffTime}
    </delete>

</mapper>