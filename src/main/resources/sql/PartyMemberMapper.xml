<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
		"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.moa.dao.partymember.PartyMemberDao">

	<!-- ResultMap: PartyMember 기본 매핑 -->
	<resultMap id="PartyMemberResultMap" type="com.moa.domain.PartyMember">
		<id property="partyMemberId" column="PARTY_MEMBER_ID"/>
		<result property="partyId" column="PARTY_ID"/>
		<result property="userId" column="USER_ID"/>
		<result property="memberRole" column="MEMBER_ROLE"/>
		<result property="memberStatus" column="MEMBER_STATUS"/>
		<result property="joinDate" column="JOIN_DATE"/>
		<result property="withdrawDate" column="WITHDRAW_DATE"/>
	</resultMap>

	<!-- ResultMap: PartyMemberResponse (JOIN) -->
	<resultMap id="PartyMemberResponseMap" type="com.moa.dto.partymember.response.PartyMemberResponse">
		<result property="partyMemberId" column="PARTY_MEMBER_ID"/>
		<result property="partyId" column="PARTY_ID"/>
		<result property="userId" column="USER_ID"/>
		<result property="memberRole" column="MEMBER_ROLE"/>
		<result property="memberStatus" column="MEMBER_STATUS"/>
		<result property="joinDate" column="JOIN_DATE"/>

		<!-- 사용자 정보 (JOIN) -->
		<result property="nickname" column="NICKNAME"/>
		<result property="profileImage" column="PROFILE_IMAGE"/>
	</resultMap>

	<!-- 파티 멤버 추가 (파티 가입) -->
	<insert id="insertPartyMember" parameterType="com.moa.domain.PartyMember" useGeneratedKeys="true" keyProperty="partyMemberId">
		INSERT INTO PARTY_MEMBER (
			PARTY_ID,
			USER_ID,
			MEMBER_ROLE,
			MEMBER_STATUS,
			JOIN_DATE
		) VALUES (
					 #{partyId},
					 #{userId},
					 #{memberRole},
					 #{memberStatus},
					 NOW()
				 )
	</insert>

	<!-- 파티 멤버 ID로 조회 (상세 정보 포함) -->
	<select id="findByPartyMemberId" resultMap="PartyMemberResponseMap">
		SELECT
			PM.PARTY_MEMBER_ID,
			PM.PARTY_ID,
			PM.USER_ID,
			PM.MEMBER_ROLE,
			PM.MEMBER_STATUS,
			PM.JOIN_DATE,

			U.NICKNAME,
			U.PROFILE_IMAGE
		FROM PARTY_MEMBER PM
				 INNER JOIN USERS U ON PM.USER_ID = U.USER_ID
		WHERE PM.PARTY_MEMBER_ID = #{partyMemberId}
	</select>

	<!-- 파티 + 사용자로 조회 (중복 참여 확인) -->
	<select id="findByPartyIdAndUserId" resultMap="PartyMemberResultMap">
		SELECT *
		FROM PARTY_MEMBER
		WHERE PARTY_ID = #{partyId}
		  AND USER_ID = #{userId}
	</select>

	<!-- 파티의 멤버 목록 조회 (방장 포함) -->
	<select id="findMembersByPartyId" resultMap="PartyMemberResponseMap">
		SELECT
			PM.PARTY_MEMBER_ID,
			PM.PARTY_ID,
			PM.USER_ID,
			PM.MEMBER_ROLE,
			PM.MEMBER_STATUS,
			PM.JOIN_DATE,

			U.NICKNAME,
			U.PROFILE_IMAGE
		FROM PARTY_MEMBER PM
				 INNER JOIN USERS U ON PM.USER_ID = U.USER_ID
		WHERE PM.PARTY_ID = #{partyId}
		  AND PM.MEMBER_STATUS = 'ACTIVE'
		ORDER BY
			CASE
				WHEN PM.MEMBER_ROLE = 'LEADER' THEN 0
				ELSE 1
				END,
			PM.JOIN_DATE ASC
	</select>

	<!-- 파티 멤버 전체 정보 업데이트 -->
	<update id="updatePartyMember" parameterType="com.moa.domain.PartyMember">
		UPDATE PARTY_MEMBER
		SET
			MEMBER_ROLE = #{memberRole},
			MEMBER_STATUS = #{memberStatus},
			WITHDRAW_DATE = #{withdrawDate}
		WHERE PARTY_MEMBER_ID = #{partyMemberId}
	</update>

	<!-- 파티 멤버 탈퇴 처리 (상태 변경 + 탈퇴일시 기록) -->
	<update id="leaveParty">
		UPDATE PARTY_MEMBER
		SET
			MEMBER_STATUS = 'LEFT',
			WITHDRAW_DATE = NOW()
		WHERE PARTY_MEMBER_ID = #{partyMemberId}
	</update>

	<!-- Find all active members in a party (for payment processing) -->
	<select id="findActiveByPartyId" resultMap="PartyMemberResultMap">
		SELECT *
		FROM PARTY_MEMBER
		WHERE PARTY_ID = #{partyId}
		  AND MEMBER_STATUS = 'ACTIVE'
		ORDER BY
			CASE
				WHEN MEMBER_ROLE = 'LEADER' THEN 0
				ELSE 1
			END,
			JOIN_DATE ASC
	</select>

	<!-- 방장 제외 활성 멤버 조회 (월 결제 스케줄러용) -->
	<select id="findActiveMembersExcludingLeader" resultMap="PartyMemberResultMap">
		SELECT *
		FROM PARTY_MEMBER
		WHERE PARTY_ID = #{partyId}
		  AND MEMBER_STATUS = 'ACTIVE'
		  AND MEMBER_ROLE != 'LEADER'
		ORDER BY JOIN_DATE ASC
	</select>

	<!-- 파티 멤버 삭제 (Toss 실패 시 롤백용) -->
	<delete id="deletePartyMember">
		DELETE FROM PARTY_MEMBER
		WHERE PARTY_MEMBER_ID = #{partyMemberId}
	</delete>

	<!-- 특정 사용자의 활성 멤버십 조회 (사용자 탈퇴 시 파티원 처리용) -->
	<select id="findActiveMembershipsByUserId" resultMap="PartyMemberResultMap">
		SELECT *
		FROM PARTY_MEMBER
		WHERE USER_ID = #{userId}
		  AND MEMBER_STATUS = 'ACTIVE'
		  AND MEMBER_ROLE != 'LEADER'
	</select>

</mapper>